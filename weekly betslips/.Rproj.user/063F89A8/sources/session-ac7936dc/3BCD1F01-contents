# Load required libraries
library(httr)
library(jsonlite)
library(utils)

# API endpoint URL for today's fixtures
api_url <- "http://api.clubelo.com/Fixtures"

# Make the GET request
response <- GET(api_url)

# Check if the request was successful
if (http_status(response)$category == "Success") {
  # Get the content as text
  response_content <- content(response, "text", encoding = "UTF-8")
  
  # The API returns CSV data, not JSON, so we need to parse it appropriately
  # Create a connection to the text content
  con <- textConnection(response_content)
  
  # Read the CSV data
  fixtures_data <- try(read.csv(con, stringsAsFactors = FALSE))
  
  # Close the connection
  close(con)
  
  # Check if data was read successfully
  if (!inherits(fixtures_data, "try-error")) {
    # Display the first few rows of the data
    print(head(fixtures_data))
    
    # Save the data to a CSV file
    write.csv(fixtures_data, file = "fixtures_data.csv", row.names = FALSE)
    cat("Data saved to fixtures_data.csv\n")
  } else {
    cat("Error parsing data from the API response\n")
    cat("Raw response content:\n")
    cat(response_content, "\n")
  }
} else {
  cat("Error fetching data from the API:", http_status(response)$message, "\n")
}

# Example of getting data for a specific date
# Note: Format should be YYYY-MM-DD
today_date <- "2023-04-15" 
api_url_with_date <- paste0("http://api.clubelo.com/Fixtures/", today_date)
response_date <- GET(api_url_with_date)

if (http_status(response_date)$category == "Success") {
  response_content_date <- content(response_date, "text", encoding = "UTF-8")
  con_date <- textConnection(response_content_date)
  fixtures_data_date <- try(read.csv(con_date, stringsAsFactors = FALSE))
  close(con_date)
  
  if (!inherits(fixtures_data_date, "try-error")) {
    # Display the first few rows of the date-specific data
    print(head(fixtures_data_date))
    
    # Save to a date-specific file
    output_file <- paste0("fixtures_data_", today_date, ".csv")
    write.csv(fixtures_data_date, file = output_file, row.names = FALSE)
    cat("Data saved to", output_file, "\n")
  } else {
    cat("Error parsing data for specific date\n")
  }
} else {
  cat("Error fetching data for specific date:", http_status(response_date)$message, "\n")
}
    
    # Save the data to a CSV file
    write.csv(fixtures_data, file = "fixtures_data.csv", row.names = FALSE)
    cat("Data saved to fixtures_data.csv\n")
  } else {
    cat("Error parsing data from the API response\n")
    cat("Raw response content:\n")
    cat(response_content, "\n")
  }
} else {
  cat("Error fetching data from the API:", http_status(response)$message, "\n")
}

# Example of getting data for a specific date (uncomment to use)
today_date <- "2023-04-15" Format: YYYY-MM-DD
api_url_with_date <- paste0("http://api.clubelo.com/Fixtures/", today_date)
response_date <- GET(api_url_with_date)
if (http_status(response_date)$category == "Success") {
response_content_date <- content(response_date, "text", encoding = "UTF-8")
con_date <- textConnection(response_content_date)
fixtures_data_date <- read.csv(con_date, stringsAsFactors = FALSE)
close(con_date)
write.csv(fixtures_data_date, file = paste0("fixtures_data_", specific_date, ".csv"), row.names = FALSE)
 }